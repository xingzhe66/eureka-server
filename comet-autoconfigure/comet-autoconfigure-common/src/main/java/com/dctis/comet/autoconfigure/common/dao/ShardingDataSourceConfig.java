package com.dctis.comet.autoconfigure.common.dao;

import com.dcits.comet.dbsharding.TableTypeMapContainer;
import com.dctis.comet.autoconfigure.common.exception.AutoConfigException;
import com.google.common.collect.Multimap;
import com.zaxxer.hikari.HikariDataSource;
import io.shardingsphere.api.algorithm.sharding.hint.HintShardingAlgorithm;
import io.shardingsphere.api.algorithm.sharding.standard.PreciseShardingAlgorithm;
import io.shardingsphere.api.config.rule.ShardingRuleConfiguration;
import io.shardingsphere.api.config.rule.TableRuleConfiguration;
import io.shardingsphere.api.config.strategy.HintShardingStrategyConfiguration;
import io.shardingsphere.api.config.strategy.StandardShardingStrategyConfiguration;
import io.shardingsphere.core.routing.strategy.ShardingAlgorithm;
import io.shardingsphere.shardingjdbc.api.ShardingDataSourceFactory;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang.StringUtils;
import org.springframework.boot.autoconfigure.condition.ConditionalOnClass;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.EnvironmentAware;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;
import org.springframework.core.env.Environment;

import javax.sql.DataSource;
import java.sql.SQLException;
import java.util.HashMap;
import java.util.Map;
import java.util.Properties;

@Slf4j
@Configuration
@ConditionalOnProperty(name = "com.dcits.comet.autoconfig.datasource.isShardingDataSource", havingValue = "true")
@ConditionalOnClass(value = {HintShardingAlgorithm.class, PreciseShardingAlgorithm.class})
@EnableConfigurationProperties({DataSourceProperties.class})
public class ShardingDataSourceConfig implements EnvironmentAware {

    private static final String DATASOURCE = "ds_";

    private Environment environment;

    @Override
    public void setEnvironment(Environment environment) {
        this.environment = environment;
    }

    @Primary
    @Bean(name = "dataSource")
    public DataSource getDataSource(final DataSourceProperties autoProperties) throws SQLException {
        if (StringUtils.isBlank(autoProperties.getShardingColumn())) {
            throw new AutoConfigException("ShardingColumn is empty");
        }
        Map<String, DataSource> dataSourceMap = getDataSourceMap(autoProperties);
        ShardingRuleConfiguration shardingRuleConfig = new ShardingRuleConfiguration();
        //未配置分片规则的表将通过默认数据源定位
        shardingRuleConfig.setDefaultDataSourceName("ds_0");
        //默认分库策略
        HintShardingAlgorithm shardingAlgorithm =
                (HintShardingAlgorithm) getHintShardingAlgorithm(autoProperties.getDefaultStrategy());
        shardingRuleConfig.setDefaultDatabaseShardingStrategyConfig(new HintShardingStrategyConfiguration(shardingAlgorithm));
        //获取表的类型和表名
        Multimap<String, String> paramMultiMap = TableTypeMapContainer.getMultiMap();
        //如果是水平分库表分片规则列表
        if (paramMultiMap.get("level").size() > 0) {
            for (String levelTableName : paramMultiMap.get("level")) {
                shardingRuleConfig.getTableRuleConfigs().add(getTableRuleConfiguration(levelTableName,
                        dataSourceMap.size(), autoProperties));
            }
        }
        //绑定表规则列表
        if (paramMultiMap.get("param").size() > 0) {
            String paramString = paramMultiMap.get("param").toString();
            shardingRuleConfig.getBindingTableGroups().add(paramString.substring(1, paramString.length() - 1));
        }
        //绑定表规则列表
        if (paramMultiMap.get("upright").size() > 0) {
            String uprightString = paramMultiMap.get("upright").toString();
            shardingRuleConfig.getBindingTableGroups().add(uprightString.substring(1, uprightString.length() - 1));
        }
        //配置信息
        Properties properties = new Properties();
        properties.setProperty("sql.show", Boolean.TRUE.toString());
        return ShardingDataSourceFactory.createDataSource(dataSourceMap, shardingRuleConfig, new HashMap(), properties);
    }

    /**
     * @return java.util.Map<java.lang.String                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               javax.sql.DataSource>
     * @Author guanlt
     * @Description 数据源集合
     * @Date 2019/5/23
     * @Param [sourceProperties]
     **/
    private Map<String, DataSource> getDataSourceMap(DataSourceProperties sourceProperties) {
        Map<String, DataSource> dataSourceMap = new HashMap<>();
        String dataSourcePrefixs = sourceProperties.getDataSourcePrefixs();
        if (StringUtils.isBlank(dataSourcePrefixs)) {
            throw new AutoConfigException("dataSourcePrefixs is empty");
        }
        String[] prefixArray = dataSourcePrefixs.split(",");
        for (int index = 0; index < prefixArray.length; index++) {
            String dataSourcePrefix = prefixArray[index];
            HikariDataSource dataSource = new HikariDataSource();
            dataSource.setJdbcUrl(environment.getProperty(dataSourcePrefix + ".jdbc-url", String.class));
            dataSource.setDriverClassName(environment.getProperty(dataSourcePrefix + ".driver-class-name", String.class));
            dataSource.setUsername(environment.getProperty(dataSourcePrefix + ".username", String.class));
            dataSource.setPassword(environment.getProperty(dataSourcePrefix + ".password", String.class));
            dataSource.setMinimumIdle(environment.getProperty(dataSourcePrefix + ".minimum-idle", Integer.class));
            dataSource.setMaximumPoolSize(environment.getProperty(dataSourcePrefix + ".maximum-pool-size", Integer.class));
            dataSource.setPoolName(environment.getProperty(dataSourcePrefix + ".pool-name", String.class));
            dataSource.setConnectionTimeout(environment.getProperty(dataSourcePrefix + ".connection-timeout", Integer.class));
            dataSource.setConnectionTestQuery(environment.getProperty(dataSourcePrefix + ".connection-test-query", String.class));
            dataSource.setMaxLifetime(environment.getProperty(dataSourcePrefix + ".max-lifetime", Integer.class));
            dataSource.setIdleTimeout(environment.getProperty(dataSourcePrefix + ".idle-timeout", Integer.class));

            Properties properties = new Properties();
            String propertiesPrefix = dataSourcePrefix + ".data-source-properties.";
            properties.setProperty("cachePrepStmts", environment.getProperty(propertiesPrefix + "cachePrepStmts", String.class));
            properties.setProperty("prepStmtCacheSize", environment.getProperty(propertiesPrefix + "prepStmtCacheSize", String.class));
            properties.setProperty("prepStmtCacheSqlLimit", environment.getProperty(propertiesPrefix + "prepStmtCacheSqlLimit", String.class));
            properties.setProperty("useServerPrepStmts", environment.getProperty(propertiesPrefix + "useServerPrepStmts", String.class));
            dataSource.setDataSourceProperties(properties);
            dataSourceMap.put(DATASOURCE + index, dataSource);
        }
        return dataSourceMap;
    }

    /**
     * @return io.shardingsphere.core.routing.strategy.ShardingAlgorithm
     * @Author guanlt
     * @Description 分库策略
     * @Date 2019/5/23
     * @Param [strategy]
     **/
    private ShardingAlgorithm getHintShardingAlgorithm(String strategy) {
        if (StringUtils.isBlank(strategy)) {
            throw new AutoConfigException("ShardingAlgorithm is empty");
        }
        try {
            Class shardingAlgorithmCls = Class.forName(strategy);
            return (ShardingAlgorithm) shardingAlgorithmCls.newInstance();
        } catch (ClassNotFoundException e) {
            log.error("ClassNotFoundException", e);
        } catch (IllegalAccessException e) {
            log.error("IllegalAccessException", e);
        } catch (InstantiationException e) {
            log.error("InstantiationException", e);
        }
        throw new AutoConfigException("getHintShardingAlgorithm error");
    }

    private TableRuleConfiguration getTableRuleConfiguration(String tableName, int dataNodeSize,
                                                             final DataSourceProperties autoProperties) {
        TableRuleConfiguration result = new TableRuleConfiguration();
        result.setLogicTable(tableName);
        result.setActualDataNodes("ds_${0.." + dataNodeSize + "}." + tableName);
        PreciseShardingAlgorithm preciseShardingAlgorithm =
                (PreciseShardingAlgorithm) getHintShardingAlgorithm(autoProperties.getDataSourceStrategy());
        result.setDatabaseShardingStrategyConfig(new StandardShardingStrategyConfiguration(autoProperties.getShardingColumn(),
                preciseShardingAlgorithm));
        return result;
    }

}
